{% extends "common/base.html" %}

{% block page_title %}Profile Update Requests{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-3">
    <div>
        <h2 class="mb-0">Profile Update Requests</h2>
        <p class="text-muted mb-0">Approve or reject marketing team's profile updates.</p>
    </div>
    <form method="get" class="d-flex gap-2 mt-3 mt-lg-0">
        <input type="text" class="form-control" name="q" placeholder="Search by employee, status, value..." value="{{ requests_search_query }}">
        <button class="btn btn-outline-primary" type="submit">Search</button>
    </form>
</div>

{% include "common/components/cards_stats.html" with cards=cards %}

<div class="row g-3 mb-3">
    <div class="col-lg-12">
        <div class="card shadow-sm h-100">
            <div class="card-body table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Employee ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Request For</th>
                            <th>Current Value</th>
                            <th>Updated Value</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in requests_page %}
                            <tr>
                                <td>{{ req.user.employee_id|default:"-" }}</td>
                                <td>{{ req.user.first_name }}</td>
                                <td>{{ req.user.last_name }}</td>
                                <td>{{ req.get_request_type_display }}</td>
                                <td>{{ req.current_value|default:"-" }}</td>
                                <td>
                                    {% if req.request_type == "profile_picture" and req.file_upload %}
                                        <a href="{{ req.file_upload.url }}" target="_blank">View</a>
                                    {% else %}
                                        {{ req.updated_value|default:"-" }}
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if req.status == "approved" %}bg-success
                                        {% elif req.status == "rejected" %}bg-danger
                                        {% else %}bg-warning text-dark{% endif %}">
                                        {{ req.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if req.status == "pending" %}
                                        <div class="d-flex gap-2">
                                            <form method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="request_id" value="{{ req.id }}">
                                                <input type="hidden" name="decision" value="approve">
                                                <button class="btn btn-sm btn-success" type="submit">Approve</button>
                                            </form>
                                            <form method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="request_id" value="{{ req.id }}">
                                                <input type="hidden" name="decision" value="reject">
                                                <button class="btn btn-sm btn-outline-danger" type="submit">Reject</button>
                                            </form>
                                        </div>
                                    {% else %}
                                        <span class="badge text-bg-secondary">{{ req.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted">No profile requests available.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if requests_paginator.num_pages > 1 %}
                    <nav class="mt-3">
                        <ul class="pagination">
                            {% if requests_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ requests_page.previous_page_number }}{% if requests_search_query %}&q={{ requests_search_query|urlencode }}{% endif %}">Previous</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">Previous</span></li>
                            {% endif %}
                            {% for num in requests_paginator.page_range %}
                                {% if requests_page.number == num %}
                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if requests_search_query %}&q={{ requests_search_query|urlencode }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            {% if requests_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ requests_page.next_page_number }}{% if requests_search_query %}&q={{ requests_search_query|urlencode }}{% endif %}">Next</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">Next</span></li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
