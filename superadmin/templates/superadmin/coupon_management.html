{% extends "common/base.html" %}
{% load static %}

{% block page_title %}Coupon Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h4 mb-1">Coupon Management</h1>
        <p class="text-muted mb-0">Create and assign coupons to Global users for specific tasks.</p>
    </div>
</div>

<div class="card shadow-sm mb-3">
    <div class="card-body">
        <h5 class="mb-3">Create Coupon</h5>
        <form method="post" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            <div class="col-md-4">
                <label class="form-label">Code</label>
                <input type="text" name="code" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Discount Type</label>
                <select name="discount_type" class="form-select">
                    <option value="fixed">Fixed gems off</option>
                    <option value="percent">Percent off</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Amount / Percent</label>
                <input type="number" step="0.01" name="amount" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Max uses per user</label>
                <input type="number" name="max_uses_per_user" class="form-control" value="1" min="1">
            </div>
            <div class="col-md-4">
                <label class="form-label">Valid From</label>
                <input type="datetime-local" name="valid_from" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Valid To</label>
                <input type="datetime-local" name="valid_to" class="form-control" required>
            </div>
            <div class="col-md-12">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-md-6">
                <label class="form-label">Applicable Tasks</label>
                <div class="d-flex flex-wrap gap-3">
                    {% for key, label in task_choices %}
                    <label class="form-check-label">
                        <input type="checkbox" class="form-check-input me-1" name="applicable_tasks" value="{{ key }}" checked> {{ label }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label">Scope</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="applies_to_all" id="appliesToAll" checked>
                    <label class="form-check-label" for="appliesToAll">Applies to all Global users</label>
                </div>
                <small class="text-muted d-block">Uncheck to assign specific users.</small>
                <select name="assigned_users" class="form-select mt-2" multiple size="6">
                    {% for u in global_users %}
                        <option value="{{ u.id }}">{{ u.get_full_name|default:u.email }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 d-flex justify-content-end">
                <button class="btn btn-primary" type="submit">Create Coupon</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm mb-3">
    <div class="card-body">
        <h5 class="mb-3">Coupons</h5>
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Uses/User</th>
                        <th>Tasks</th>
                        <th>Scope</th>
                        <th>Validity</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in coupons %}
                    <tr>
                        <td>{{ c.code }}</td>
                        <td>{{ c.get_discount_type_display }}</td>
                        <td>{{ c.amount }}</td>
                        <td>{{ c.max_uses_per_user }}</td>
                        <td>
                            {% if c.applicable_tasks %}
                                {{ c.applicable_tasks|join:", " }}
                            {% else %}
                                All
                            {% endif %}
                        </td>
                        <td>{% if c.applies_to_all %}All Globals{% else %}Specific{% endif %}</td>
                        <td>{{ c.valid_from|date:"d M Y H:i" }} â€“ {{ c.valid_to|date:"d M Y H:i" }}</td>
                        <td>
                            {% if c.is_active %}
                                <span class="badge text-bg-success">Active</span>
                            {% else %}
                                <span class="badge text-bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="toggle">
                                <input type="hidden" name="coupon_id" value="{{ c.id }}">
                                <button class="btn btn-sm btn-outline-secondary" type="submit">
                                    {% if c.is_active %}Deactivate{% else %}Activate{% endif %}
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" class="text-center text-muted">No coupons yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if coupon_paginator and coupon_paginator.num_pages > 1 %}
        <nav aria-label="Coupons pagination">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not coupon_page_obj.has_previous %}disabled{% endif %}">
                    {% if coupon_page_obj.has_previous %}
                        <a class="page-link" href="?coupon_page={{ coupon_page_obj.previous_page_number }}&{{ base_query }}">Prev</a>
                    {% else %}
                        <span class="page-link">Prev</span>
                    {% endif %}
                </li>
                {% for num in coupon_paginator.page_range %}
                    <li class="page-item {% if coupon_page_obj.number == num %}active{% endif %}">
                        <a class="page-link" href="?coupon_page={{ num }}&{{ base_query }}">{{ num }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if not coupon_page_obj.has_next %}disabled{% endif %}">
                    {% if coupon_page_obj.has_next %}
                        <a class="page-link" href="?coupon_page={{ coupon_page_obj.next_page_number }}&{{ base_query }}">Next</a>
                    {% else %}
                        <span class="page-link">Next</span>
                    {% endif %}
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="mb-3">Recent Redemptions</h5>
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead>
                    <tr>
                        <th>When</th>
                        <th>Coupon</th>
                        <th>User</th>
                        <th>Task</th>
                        <th>Discount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in redemptions %}
                    <tr>
                        <td>{{ r.created_at|date:"d M Y H:i" }}</td>
                        <td>{{ r.coupon.code }}</td>
                        <td>{{ r.user.get_full_name|default:r.user.email }}</td>
                        <td>{{ r.task_type|capfirst }}</td>
                        <td>{{ r.gems_discounted }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center text-muted">No redemptions yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if redemption_paginator and redemption_paginator.num_pages > 1 %}
        <nav aria-label="Redemptions pagination">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not redemption_page_obj.has_previous %}disabled{% endif %}">
                    {% if redemption_page_obj.has_previous %}
                        <a class="page-link" href="?redemption_page={{ redemption_page_obj.previous_page_number }}&{{ base_query }}">Prev</a>
                    {% else %}
                        <span class="page-link">Prev</span>
                    {% endif %}
                </li>
                {% for num in redemption_paginator.page_range %}
                    <li class="page-item {% if redemption_page_obj.number == num %}active{% endif %}">
                        <a class="page-link" href="?redemption_page={{ num }}&{{ base_query }}">{{ num }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if not redemption_page_obj.has_next %}disabled{% endif %}">
                    {% if redemption_page_obj.has_next %}
                        <a class="page-link" href="?redemption_page={{ redemption_page_obj.next_page_number }}&{{ base_query }}">Next</a>
                    {% else %}
                        <span class="page-link">Next</span>
                    {% endif %}
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}
